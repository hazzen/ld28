function isDef(a){return void 0!==a}var requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();json={},json.load=function(a,b){var c=new XMLHttpRequest;c.onload?(c.onload=function(){b(JSON.parse(c.responseText))},c.onerror=function(){throw c.statusText}):c.onreadystatechange=function(){if(4==c.readyState){if(200!=c.status)throw c.statusText;b(JSON.parse(c.responseText))}},c.open("get",a,!0),c.send()},MT=function(a){this.pool=new Array(624),this.index=0,this.init_(a)},MT.prototype.init_=function(a){this.pool[0]=a;for(var b=1;b<this.pool.length;b++){var c=this.pool[b-1];this.pool[b]=1812433253*(c^c>>30)+b&4294967295}},MT.prototype.next=function(){0==this.index&&this.gen();var a=this.pool[this.index];return a^=a>>11,a^=a<<7&2636928640,a^=a<<15&4022730752,a^=a>>18,this.index=(this.index+1)%624,a/2147481981},MT.prototype.nextFloat=function(a,b){var c=0,d=a;return isDef(b)&&(c=a,d=b),this.next()*(d-c)+c},MT.prototype.nextInt=function(a,b){return Math.floor(this.nextFloat(a,b))},MT.prototype.nextSign=function(){return this.next()<.5?-1:1},MT.prototype.gen=function(){for(var a=0;a<this.pool.length;a++){var b=(a+1)%this.pool.length,c=(2147483648&this.pool[a])+(2147483647&this.pool[b]);this.pool[a]=this.pool[(a+397)%624]^c>>1,c%2&&(this.pool[a]^=2567483615)}},FRAME_RATE=60,DEBUG=!1,Keys={ENTER:13,ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16},KB={},KB.keyDown_={},KB.keyDownCounts_={},KB.clear=function(){KB.keyDown_={},KB.keyDownCounts_={}},KB.keyPressed=function(a){return 1==KB.keyDown(a)},KB.NON_ASCII={",":188,".":190,";":186,"[":219,"]":221},KB.keyDown=function(a){if("string"!=typeof a)return KB.keyDownCounts_[a];var b=a.toUpperCase().charCodeAt(0);if(b>=48&&57>=b||b>=65&&90>=b)return KB.keyDownCounts_[b];var c=KB.NON_ASCII[a];return c?KB.keyDownCounts_[c]:(alert("Don't know key code for \""+a+'"!'),void 0)},KB.tickHandleInput_=function(){for(var a in KB.keyDown_)KB.keyDownCounts_[a]?KB.keyDownCounts_[a]++:KB.keyDownCounts_[a]=1;for(var a in KB.keyDownCounts_)KB.keyDown_[a]||(KB.keyDownCounts_[a]=0)},KB.onKeyDown=function(a){return 77==a.keyCode&&a.ctrlKey?!1:(KB.keyDown_[a.keyCode]=!0,a.keyCode<112?(a.preventDefault(),!1):void 0)},KB.onKeyUp=function(a){return KB.keyDown_[a.keyCode]=!1,a.keyCode<112?(a.preventDefault(),!1):void 0},Pidgine={},Pidgine.run=function(a){a.elem.addEventListener("keydown",KB.onKeyDown),a.elem.addEventListener("keyup",KB.onKeyUp);var b=(new Date).getTime();!function c(){var d=(new Date).getTime(),e=Math.floor((d-b)/(1e3/FRAME_RATE));b+=e*(1e3/FRAME_RATE),e>5&&(e=1);for(var f=0;e>f;f++)KB.tickHandleInput_(),a.tick(1/FRAME_RATE);e>0&&a.render(),requestAnimFrame(c)}()},function(a){var b={};b.STACK=[],b.current=function(){return b.STACK[b.STACK.length-1]},b.tick=function(a){b.current().stage.tick(a),b.current().tick&&b.current().tick(a)},b.render=function(a){a.render(b.current().stage)},b.push=function(a){b.STACK.push(a),a.enter&&a.enter()},b.pop=function(){var a=b.STACK.pop();a&&a.exit&&a.exit()},a.GameState=b}(window),function(a){var b=function(a,b){if(void 0===b){if(void 0==a)throw"Bad x val";this.x=a.x,this.y=a.y}else this.x=a,this.y=b};b.prototype.toVec3=function(){return new c(this.x,this.y,0)},b.prototype.m_plus=function(a){this.x+=a.x,this.y+=a.y},b.prototype.plus=function(a){var c=new b(this.x,this.y);return c.m_plus(a),c},b.prototype.m_minus=function(a){this.x-=a.x,this.y-=a.y},b.prototype.minus=function(a){var c=new b(this.x,this.y);return c.m_minus(a),c},b.prototype.m_times=function(a){this.x*=a,this.y*=a},b.prototype.times=function(a){var c=new b(this.x,this.y);return c.m_times(a),c},b.prototype.dot=function(a){return this.x*a.x+this.y*a.y},b.prototype.cross=function(a){return this.x*a.y-this.y*a.x},b.prototype.m_normalize=function(){var a=this.mag();this.x/=a,this.y/=a},b.prototype.normalize=function(){var a=new b(this.x,this.y);return a.m_normalize(),a},b.prototype.mag=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y);return a},b.prototype.mag2=function(){return this.x*this.x+this.y*this.y},b.fromTheta=function(a){return new b(Math.cos(a),Math.sin(a))},b.prototype.theta=function(){var a=Math.atan2(this.y,this.x);return a},b.prototype.m_normal=function(a){var b=(a?1:-1)*this.y,c=(a?-1:1)*this.x;this.x=b,this.y=c},b.prototype.normal=function(a){var c=new b(this.x,this.y);return c.m_normal(a),c},b.prototype.m_rotate=function(a){var b=this.theta();b+=a;var c=this.mag();this.x=Math.cos(b)*c,this.y=Math.sin(b)*c},b.prototype.rotate=function(a){var c=new b(this.x,this.y);return c.m_rotate(a),c};var c=function(a,b,c){if(void 0===b){if(void 0==a)throw"Bad x val";this.x=a.x,this.y=a.y,this.z=a.z}else this.x=a,this.y=b,this.z=c};c.prototype.toVec2=function(){return new b(this.x,this.y)},c.prototype.m_plus=function(a){this.x+=a.x,this.y+=a.y,this.z+=a.z},c.prototype.plus=function(a){var b=new c(this);return b.m_plus(a),b},c.prototype.m_minus=function(a){this.x-=a.x,this.y-=a.y,this.z-=a.z},c.prototype.minus=function(a){var b=new c(this);return b.m_minus(a),b},c.prototype.m_times=function(a){this.x*=a,this.y*=a,this.z*=a},c.prototype.times=function(a){var b=new c(this);return b.m_times(a),b},c.prototype.dot=function(a){return this.x*a.x+this.y*a.y+this.z*a.z},c.prototype.cross=function(a){return new c(this.y*a.z-this.z*a.y,this.z*a.x-this.x*a.z,this.x*a.y-this.y*a.x)},c.prototype.m_normalize=function(){var a=this.mag();this.x/=a,this.y/=a,this.z/=a},c.prototype.normalize=function(){var a=new c(this);return a.m_normalize(),a},c.prototype.mag=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return a},c.prototype.mag2=function(){return this.x*this.x+this.y*this.y+this.z*this.z};var d=function(a,b,c,d,e,f){this.m11=a,this.m12=b,this.m21=c,this.m22=d,this.tx=e,this.ty=f};d.ident=function(){return new d(1,0,0,1,0,0)},d.diag=function(a,b){return new d(a,0,0,b,0,0)},d.translate=function(a,b){return new d(1,0,0,1,a,b)},d.rotate=function(a){return new d(Math.cos(a),-Math.sin(a),Math.sin(a),Math.cos(a),0,0)},d.translateRotate=function(a,b,c){return new d(Math.cos(c),-Math.sin(c),Math.sin(c),Math.cos(c),a,b)},d.prototype.mult=function(a){var b=new d(this.m11,this.m12,this.m21,this.m22,this.tx,this.ty);return b.m_mult(a),b},d.prototype.m_mult=function(a){var b=this.m11*a.m11+this.m12*a.m21,c=this.m11*a.m12+this.m12*a.m22,d=this.m11*a.tx+this.m12*a.ty+this.tx,e=this.m21*a.m11+this.m22*a.m21,f=this.m21*a.m12+this.m22*a.m22,g=this.m21*a.tx+this.m22*a.ty+this.ty;this.m11=b,this.m12=c,this.m21=e,this.m22=f,this.tx=d,this.ty=g},d.prototype.scaleVec=function(a){var b=new c(a.x,a.y);return this.m_scaleVec(b),b},d.prototype.m_scaleVec=function(a){var b=this.m11*a.x+this.m12*a.y+this.tx,c=this.m21*a.x+this.m22*a.y+this.ty;a.x=b,a.y=c};var e=function(a,b,c,d,e,f,g,h,i,j,k,l){this.m11=a,this.m12=b,this.m13=c,this.m21=d,this.m22=e,this.m23=f,this.m31=g,this.m32=h,this.m33=i,this.tx=j,this.ty=k,this.tz=l};e.ident=function(){return new e(1,0,0,0,1,0,0,0,1,0,0,0)},e.diag=function(a,b,c){return new e(a,0,0,0,b,0,0,0,c,0,0,0)},e.lookAt=function(a,b,c){var d=a.minus(b);d.m_normalize();var f=c.cross(d);f.m_normalize();var g=d.cross(f);g.m_normalize();var h=new e(f.x,f.y,f.z,g.x,g.y,g.z,d.x,d.y,d.z,0,0,0),i=e.translate(-a.x,-a.y,-a.z);return h.m_mult(i),h},e.ortho=function(a,b,c,d,f,g){var h=-(b+a)/(b-a),i=-(d+c)/(d-c),j=-(g+f)/(g-f),k=2/(b-a),l=2/(d-c),m=-2/(g-f);return new e(k,0,0,0,l,0,0,0,m,h,i,j)},e.translate=function(a,b,c){return new e(1,0,0,0,1,0,0,0,1,a,b,c)},e.rotate=function(a,b){var c=Math.cos(b),d=1-c,f=Math.sin(b),g=a.x,h=a.y,i=a.z,j=g*g,k=i*i;return new e(c+j*d,g*h*d-i*f,g*i*d+h*f,h*g*d+i*f,c+h*d,h*i*d-g*f,i*g*d-h*f,i*h*d+g*f,c+k*d,0,0,0)},e.prototype.clone=function(){return new e(this.m11,this.m12,this.m13,this.m21,this.m22,this.m23,this.m31,this.m32,this.m33,this.tx,this.ty,this.tz)},e.prototype.flatten=function(){return[this.m11,this.m21,this.m31,0,this.m12,this.m22,this.m32,0,this.m13,this.m23,this.m33,0,this.tx,this.ty,this.tz,1]},e.prototype.inverseTranspose=function(){var a=this.m11*this.m22-this.m21*this.m12,b=this.m11*this.m23-this.m21*this.m13,c=this.m11*this.ty-this.m21*this.tx,d=this.m12*this.m23-this.m22*this.m13,e=this.m12*this.ty-this.m22*this.tx,f=this.m13*this.ty-this.m23*this.tx,g=1*this.m33-0*this.tz,h=1*this.m32-0*this.tz,i=0*this.m32-0*this.m33,j=1*this.m31-0*this.tz,k=0*this.m31-0*this.m33,l=0*this.m31-0*this.m32,m=1/(a*g-b*h+c*i+d*j-e*k+f*l),n=(this.m22*g-this.m23*h+this.ty*i)*m,o=(-this.m12*g+this.m13*h-this.tx*i)*m,p=(0*f-0*e+1*d)*m,q=(-this.m21*g+this.m23*j-this.ty*k)*m,r=(this.m11*g-this.m13*j+this.tx*k)*m,s=(-0*f+0*c-1*b)*m,t=(this.m21*h-this.m22*j+this.ty*l)*m,u=(-this.m11*h+this.m12*j-this.tx*l)*m,v=(0*e-0*c+1*a)*m;return[n,q,t,o,r,u,p,s,v]},e.prototype.mult=function(a){var b=new e(this.m11,this.m12,this.m13,this.m21,this.m22,this.m23,this.m31,this.m32,this.m33,this.tx,this.ty,this.tz);return b.m_mult(a),b},e.prototype.m_mult=function(a){var b=this.m11*a.m11+this.m12*a.m21+this.m13*a.m31,c=this.m11*a.m12+this.m12*a.m22+this.m13*a.m32,d=this.m11*a.m13+this.m12*a.m23+this.m13*a.m33,e=this.m11*a.tx+this.m12*a.ty+this.m13*a.tz+this.tx,f=this.m21*a.m11+this.m22*a.m21+this.m23*a.m31,g=this.m21*a.m12+this.m22*a.m22+this.m23*a.m32,h=this.m21*a.m13+this.m22*a.m23+this.m23*a.m33,i=this.m21*a.tx+this.m22*a.ty+this.m23*a.tz+this.ty,j=this.m31*a.m11+this.m32*a.m21+this.m33*a.m31,k=this.m31*a.m12+this.m32*a.m22+this.m33*a.m32,l=this.m31*a.m13+this.m32*a.m23+this.m33*a.m33,m=this.m31*a.tx+this.m32*a.ty+this.m33*a.tz+this.tz;this.m11=b,this.m12=c,this.m13=d,this.m21=f,this.m22=g,this.m23=h,this.m31=j,this.m32=k,this.m33=l,this.tx=e,this.ty=i,this.tz=m},e.prototype.scaleVec=function(a){var b=new c(a.x,a.y,a.z);return this.m_scaleVec(b),b},e.prototype.m_scaleVec=function(a){var b=this.m11*a.x+this.m12*a.y+this.m13*a.z+this.tx,c=this.m21*a.x+this.m22*a.y+this.m23*a.z+this.ty,d=this.m31*a.x+this.m32*a.y+this.m33*a.z+this.tz;a.x=b,a.y=c,a.z=d};var f=function(a,b,c,d){this.x1=a,this.y1=b,this.x2=a+c,this.y2=b+d};f.prototype.m_fromCenterAndSize=function(a,b){this.x1=a.x-b.x/2,this.y1=a.y-b.y/2,this.x2=a.x+b.x/2,this.y2=a.y+b.y/2},f.fromCenterAndSize=function(a,b){return new f(a.x-b.x/2,a.y-b.y/2,b.x,b.y)},f.prototype.overlaps=function(a){return!(this.x1>a.x2||this.x2<a.x1||this.y1>a.y2||this.y2<a.y1)},a.geom={Vec2:b,Vec3:c,Mat3:d,Mat4:e,AABB:f}}(window),function(a){function b(){this.stack_=[geom.Mat4.ident()]}function c(a,b,c){this.stage=b,this.key=a,this.gl_=c,this.size=16,this.sprites_=[],this.reset()}function d(a,c){this.beat=[1,1,1,1],this.modelToCamera_=new b,this.cameraPos_=new geom.Vec3(0,0,10),this.cameraTarget_=new geom.Vec3(0,0,0),this.perspective_=geom.Mat4.ortho(-a/2,a/2,-c/2,c/2,-100,100),this.lighting_=new n(new geom.Vec3(.1,.1,.1),1/4900),this.batches_=[]}function e(a,b,c){this.canvasElem_=document.createElement("canvas"),this.canvasElem_.setAttribute("width",b),this.canvasElem_.setAttribute("height",c),a.appendChild(this.canvasElem_),this.gl_=this.canvasElem_.getContext("webgl"),this.gl_||(this.gl_=this.canvasElem_.getContext("experimental-webgl")),this.gl_||alert("gl init failed"),this.w_=this.canvasElem_.width,this.h_=this.canvasElem_.height,this.shaders_=new k,this.shaders_.load(this)}function f(a,b,c,d){this.name=b,this.source=c,this.type=d,this.gl_=a,this.shader=null}function g(a,b,c){this.name=b,this.shaders=c,this.gl_=a,this.program=null}function h(a,b,c){this.texture=b,this.desc=c,this.name=c.meta.image,this.gl_=a,this.w=this.desc.meta.size.w,this.h=this.desc.meta.size.h,this.loaded=!1}function i(a,b,c,d){this.texture=b,this.atlas=d,this.gl_=a,this.loaded=!1,this.name=c}function j(a){this.visible=!0,this.gl_=a,this.w_=1,this.h_=1,this.ws_=1,this.hs_=1,this.pos_=new geom.Vec3(0,0,0),this.beats=0,this.normalMap=j.defaultNormalMap_(a)}function k(){this.texturedProg=null,this.flatProg=null}var l=0;b.prototype.scaleVec=function(a){return this.stack_[this.stack_.length-1].scaleVec(a)},b.prototype.m_scaleVec=function(a){return this.stack_[this.stack_.length-1].m_scaleVec(a)},b.prototype.top=function(){return this.stack_[this.stack_.length-1].clone()},b.prototype.x=function(a){var b=this.stack_.length-1;return this.stack_[b]=this.stack_[b].mult(a),this},b.prototype.push=function(a){this.stack_.push(a||this.top())},b.prototype.pop=function(){this.stack_.pop()},c.getKey=function(a){if(a.mtl)return"";var b=a.texture.name,c=a.normalMap.name;return b==c?b:b+" "+c},c.KINDS={position:{size:3},texCord:{size:2},norCord:{size:2},colorFilter:{size:3}},c.ELEM_SIZE=10,c.prototype.addSprite=function(a){this.diffuseTexture=a.texture.texture,this.normalTexture=a.normalMap.texture,this.sprites_.push(a),this.size<this.sprites_.length&&(this.size=Math.floor(1.5*this.size),this.reset())},c.prototype.removeSprite=function(a){var b=this.sprites_.indexOf(a);if(-1==b)throw"Sprite not a child!";this.sprites_[b]=this.sprites_[this.sprites_.length-1],this.sprites_.pop(),a.stage=null},c.prototype.reset=function(){var a=this.gl_;this.buffer=new Float32Array(this.size*c.ELEM_SIZE*4),this.elements=new Uint16Array(6*this.size),this.verBuffer=a.createBuffer(),this.eleBuffer=a.createBuffer(),this.offsets={};var b=0;for(var d in c.KINDS)this.offsets[d]=b,b+=c.KINDS[d].size;this.steps=c.ELEM_SIZE;for(var e=0;e<this.size;e++)this.elements[6*e+0]=4*e+UNIT_SQUARE_ELEMS[0],this.elements[6*e+1]=4*e+UNIT_SQUARE_ELEMS[1],this.elements[6*e+2]=4*e+UNIT_SQUARE_ELEMS[2],this.elements[6*e+3]=4*e+UNIT_SQUARE_ELEMS[3],this.elements[6*e+4]=4*e+UNIT_SQUARE_ELEMS[4],this.elements[6*e+5]=4*e+UNIT_SQUARE_ELEMS[5];a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.eleBuffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.elements,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,this.verBuffer),a.bufferData(a.ARRAY_BUFFER,this.buffer,a.DYNAMIC_DRAW)},c.prototype.draw=function(a,b){var d=this.gl_;this.fillBuffers(a),d.bindBuffer(d.ARRAY_BUFFER,this.verBuffer),d.bufferSubData(d.ARRAY_BUFFER,0,this.buffer);for(var e in this.offsets){var f=this.offsets[e],g=c.KINDS[e];d.vertexAttribPointer(b.getAttribLocation(e),g.size,d.FLOAT,!1,this.steps*Float32Array.BYTES_PER_ELEMENT,f*Float32Array.BYTES_PER_ELEMENT)}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this.eleBuffer),d.drawElements(d.TRIANGLES,6*this.sprites_.length,d.UNSIGNED_SHORT,0)},c.prototype.fillBuffers=function(a){for(var b=new geom.Vec3(0,0,0),c=new geom.Vec3(0,0,0),d=new geom.Vec3(0,0,0),e=new geom.Vec3(0,0,0),f=new geom.Vec3(0,0,0),g=0;g<this.sprites_.length;g++){var h=this.sprites_[g],i=h.colorFilter||f;a.push(),a.x(geom.Mat4.translate(h.pos_.x,h.pos_.y,h.pos_.z)),h.axis_&&a.x(geom.Mat4.rotate(h.axis_,h.angle_));var j=h.size();(1!=j.x||1!=j.y)&&a.x(geom.Mat4.diag(j.x,j.y,1));var k=Math.sin(Math.PI*this.stage.beat[h.beat||0])/5;h.beat<0&&(k=0),b.x=-.5-k,b.y=.5+k,b.z=0,c.x=.5+k,c.y=.5+k,c.z=0,d.x=-.5-k,d.y=-.5-k,d.z=0,e.x=.5+k,e.y=-.5-k,e.z=0,a.m_scaleVec(b),a.m_scaleVec(c),a.m_scaleVec(d),a.m_scaleVec(e);var l=this.offsets.position+g*this.steps*4,m=this.offsets.texCord+g*this.steps*4,n=this.offsets.norCord+g*this.steps*4,o=this.offsets.colorFilter+g*this.steps*4,p=h.texture.atlas||{x:0,y:0,w:1,h:1},q=h.normalMap.atlas||{x:0,y:0,w:1,h:1};this.buffer[l+0]=b.x,this.buffer[l+1]=b.y,this.buffer[l+2]=b.z,this.buffer[m+0]=p.x,this.buffer[m+1]=p.y,this.buffer[n+0]=q.x,this.buffer[n+1]=q.y,this.buffer[o+0]=i.x,this.buffer[o+1]=i.y,this.buffer[o+2]=i.z,l+=this.steps,m+=this.steps,n+=this.steps,o+=this.steps,this.buffer[l+0]=c.x,this.buffer[l+1]=c.y,this.buffer[l+2]=c.z,this.buffer[m+0]=p.x+p.w,this.buffer[m+1]=p.y,this.buffer[n+0]=q.x+q.w,this.buffer[n+1]=q.y,this.buffer[o+0]=i.x,this.buffer[o+1]=i.y,this.buffer[o+2]=i.z,l+=this.steps,m+=this.steps,n+=this.steps,o+=this.steps,this.buffer[l+0]=d.x,this.buffer[l+1]=d.y,this.buffer[l+2]=d.z,this.buffer[m+0]=p.x,this.buffer[m+1]=p.y+p.h,this.buffer[n+0]=q.x,this.buffer[n+1]=q.y+q.h,this.buffer[o+0]=i.x,this.buffer[o+1]=i.y,this.buffer[o+2]=i.z,l+=this.steps,m+=this.steps,n+=this.steps,o+=this.steps,this.buffer[l+0]=e.x,this.buffer[l+1]=e.y,this.buffer[l+2]=e.z,this.buffer[m+0]=p.x+p.w,this.buffer[m+1]=p.y+p.h,this.buffer[n+0]=q.x+q.h,this.buffer[n+1]=q.y+q.h,this.buffer[o+0]=i.x,this.buffer[o+1]=i.y,this.buffer[o+2]=i.z,a.pop()}},d.prototype.clear=function(){this.batches_=[],this.lighting_=new n(new geom.Vec3(.1,.1,.1),1/4900)},d.prototype.tick=function(a){this.lighting_.tick(a),this.beat[0]+=a,this.beat[1]+=a/3,this.beat[2]+=a/5,this.beat[3]+=a/7,this.beat[0]%=1,this.beat[1]%=1,this.beat[2]%=1,this.beat[3]%=1},d.prototype.lighting=function(){return this.lighting_},d.prototype.addSprite=function(a){a.stage=this;for(var b,d=c.getKey(a),e=0;e<this.batches_.length;e++)if(this.batches_[e].key==d){b=this.batches_[e];break}b||(b=new c(d,this,a.gl_),this.batches_.push(b)),b.addSprite(a)},d.prototype.removeSprite=function(a){for(var b,d=c.getKey(a),e=0;e<this.batches_.length;e++)if(this.batches_[e].key==d){b=this.batches_[e];break}if(!b)throw"Sprite not a child!";b.removeSprite(a)},e.prototype.getElement=function(){return this.canvasElem_},e.prototype.width=function(){return this.w_},e.prototype.height=function(){return this.h_},e.prototype.gl=function(){return this.gl_},e.prototype.lighting=function(){return this.stage_.lighting_},e.prototype.modelToCamera=function(){return this.stage_.modelToCamera_},e.prototype.render=function(a){this.stage_=a;var b=this.gl_;b.clearColor(0,0,0,1),b.blendFunc(b.SRC_ALPHA,b.ONE),b.enable(b.BLEND),b.enable(b.DEPTH_TEST),b.disable(b.CULL_FACE),b.clear(b.COLOR_BUFFER_BIT);var c=this.stage_.cameraPos_,d=this.stage_.cameraTarget_,e=geom.Mat4.lookAt(c,d,new geom.Vec3(0,1,0));this.modelToCamera().push(e),this.renderSprites_(),this.modelToCamera().pop()},e.prototype.renderSprites_=function(){var a=this.gl_;if(this.stage_.batches_.length){this.useProgram_(this.shaders_.texturedProg);for(var b=0;b<this.stage_.batches_.length;b++){var c=this.stage_.batches_[b];a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,c.diffuseTexture),a.uniform1i(this.prog_.getUniformLocation("diffuseSampler"),0),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,c.normalTexture),a.uniform1i(this.prog_.getUniformLocation("normalSampler"),1),c.draw(this.modelToCamera(),this.prog_)}}},e.prototype.program=function(){return this.prog_},e.prototype.cameraToClip=function(){return this.stage_.perspective_},e.prototype.useProgram_=function(a){var b=this.gl_;if(this.prog_!=a&&this.prog_&&this.prog_.detach(),this.prog_=a,this.prog_){this.prog_.use();var c=a.getUniformLocation("cameraToClipMatrix");b.uniformMatrix4fv(c,!1,new Float32Array(this.cameraToClip().flatten())),this.stage_.lighting_.bind_(this),b.uniform4f(a.getUniformLocation("beats"),Math.sin(Math.PI*this.stage_.beat[0]),Math.sin(Math.PI*this.stage_.beat[1]),Math.sin(Math.PI*this.stage_.beat[2]),Math.sin(Math.PI*this.stage_.beat[3]))}},e.prototype.shaderFromElement=function(a){var b,c=this.gl_,d=a.textContent;if("x-shader/x-fragment"==a.type)b=c.FRAGMENT_SHADER;else{if("x-shader/x-vertex"!=a.type)return window.console.log("Unknown shader type: "+a.type),null;b=c.VERTEX_SHADER}return this.shaderFromText(d,b)},e.prototype.shaderFromText=function(a,b,c){var d=new f(this.gl_,a,b,c);return d.compile()&&d},e.prototype.shaderProgram=function(a,b){var c=new g(this.gl_,a,b);return c.link()&&c},f.prototype.compile=function(){var a=this.gl_;return this.shader?(window.console.log('Attempting to compile "'+this.name+'" a second time, aborting.'),!0):(this.shader=a.createShader(this.type),a.shaderSource(this.shader,this.source),a.compileShader(this.shader),a.getShaderParameter(this.shader,a.COMPILE_STATUS)?!0:(window.console.log('Error loading shader "'+this.name+'": '+a.getShaderInfoLog(this.shader)),this.shader=null,!1))},f.prototype.free=function(){var a=this.gl_;a.deleteShader(this.shader),this.shader=null},g.prototype.link=function(){var a=this.gl_;if(this.program)return window.console.log('Attempting to compile "'+this.name+'" a second time, aborting.'),!0;this.program=a.createProgram();for(var b=0;b<this.shaders.length;++b)a.attachShader(this.program,this.shaders[b].shader);return a.linkProgram(this.program),a.getProgramParameter(this.program,a.LINK_STATUS)?!0:(window.console.log('Unable to link shader "'+this.name+'": '+a.getProgramInfoLog(this.program)),this.program=null,!1)},g.prototype.use=function(){var a=this.gl_;return this.uniforms_={},this.attribs_={},this.program?(a.useProgram(this.program),void 0):(window.console.log("Attempting to use uncompiled shader, aborting."),null)},g.prototype.detach=function(){var a=this.gl_;return this.program?(a.useProgram(null),void 0):(window.console.log("Attempting to use uncompiled shader, aborting."),null)},g.prototype.free=function(){var a=this.gl_;a.deleteProgram(this.program);for(var b=0;b<this.shaders.length;++b)this.shaders[b].free();this.program=null},g.prototype.getUniformLocation=function(a){if(a in this.uniforms_)return this.uniforms_[a];var b=this.gl_.getUniformLocation(this.program,a);return this.uniforms_[a]=b,b},g.prototype.getAttribLocation=function(a){var b;return a in this.attribs_?b=this.attribs_[a]:(b=this.gl_.getAttribLocation(this.program,a),this.attribs_[a]=b),-1!=b&&this.gl_.enableVertexAttribArray(b),b},h.prototype.fromImg_=function(a){if(!this.loaded){this.loaded=!0;var b=this.gl_;b.bindTexture(b.TEXTURE_2D,this.texture),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.bindTexture(b.TEXTURE_2D,null),this.textures={};for(var c in this.desc.frames){var d=this.desc.frames[c].frame,e=new i(b,this.texture,this.name,{name:c,x:d.x/this.w,y:d.y/this.h,w:d.w/this.w,h:d.h/this.h});e.w=d.w,e.h=d.h,this.textures[c]=e}}},h.load=function(a,b,c){var d=new h(a,a.createTexture(),b),e=new Image;return e.onload=function(){d.fromImg_(e),c(d)},e.src=d.name,d},h.prototype.textureFor=function(a){return this.textures[a]},i.prototype.fromImg_=function(a){if(!this.loaded){this.loaded=!0,this.w=a.width,this.h=a.height;var b=this.gl_;b.bindTexture(b.TEXTURE_2D,this.texture),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.bindTexture(b.TEXTURE_2D,null)}},i.getCanvas_=function(a){var b=document.getElementById("scratch-canvas");return b||(b=document.createElement("canvas"),b.id="scratch-canvas",b.style.display="none",document.body.appendChild(b)),b.width=a.width,b.height=a.height,b},i.fromCanvas=function(a,b,c){var d=i.getCanvas_(b),e=d.getContext("2d");c(e);var f=new i(a,a.createTexture(),l++ +"-canvas");return f.fromImg_(d),f},i.ofColor=function(a,b,c){var d=c||{width:2,height:2};return i.fromCanvas(a,d,function(a){a.fillStyle=b,a.fillRect(0,0,d.width,d.height)})},i.sub=function(a,b,c){var d={x:0,y:0,w:1,h:1};a.atlas&&(d.x=a.atlas.x,d.y=a.atlas.y,d.w=a.atlas.w,d.h=a.atlas.h);var e=d.x+d.w,f=d.y+d.h;d.x+=Math.min(d.w,b.x/a.w*d.w),d.y+=Math.min(d.h,b.y/a.h*d.h),d.w=d.w*c.x/a.w,d.h=d.h*c.y/a.h,d.x+d.w>e&&(d.w=e-d.x),d.y+d.h>f&&(d.h=f-d.y);var g=new i(a.gl,a.texture,a.name,d);return g.w=c.x,g.h=c.y,g},i.load=function(a,b,c){var d=new i(a,a.createTexture(),b),e=new Image;return e.onload=function(){d.fromImg_(e),c()},e.src=b,d},i.prototype.free=function(){var a=this.gl_;a.deleteTexture(this.texture),this.texture=null};var m=function(a,b){this.pointLight_=!0,this.pos=a,this.color=b};m.globalLight=function(a,b){var c=new m(a.normalize(),b);return c.pointLight_=!1,c},m.NO_OP=new m(new geom.Vec3(0,0,0),new geom.Vec3(0,0,0));var n=function(a,b){this.ambient=a,this.atten=b,this.maxIntensity=this.targetIntensity=1,this.intensityV_=0,this.gamma=1.1,this.lights=[m.NO_OP,m.NO_OP,m.NO_OP,m.NO_OP]};n.prototype.setMaxIntensity=function(a){this.targetIntensity=a},n.prototype.tick=function(a){var b=function(a){return 0>a?-1:a>0?1:0},c=this.targetIntensity-this.maxIntensity;0!=c&&(b(c)!=this.intensityV_&&(this.intensityV_=0),this.intensityV_+=b(c)*a,Math.abs(c)<Math.abs(this.intensityV_)?(this.maxIntensity=this.targetIntensity,this.intensityV_=0):this.maxIntensity+=this.intensityV_)},n.prototype.bind_=function(a){for(var b=a.gl(),c=a.program(),d=0;d<this.lights.length;++d){var e=this.lights[d],f=e.pos;f=e.pointLight_?a.modelToCamera().top().scaleVec(f):a.cameraToClip().scaleVec(f).normalize();var g=c.getUniformLocation("lighting.lights["+2*d+"]");b.uniform4f(g,f.x,f.y,f.z,e.pointLight_?1:0);var h=c.getUniformLocation("lighting.lights["+(2*d+1)+"]");b.uniform4f(h,e.color.x,e.color.y,e.color.z,1)}b.uniform1f(c.getUniformLocation("lighting.attenuation"),this.atten),b.uniform1f(c.getUniformLocation("lighting.maxIntensity"),this.maxIntensity),b.uniform1f(c.getUniformLocation("lighting.gamma"),this.gamma),b.uniform4f(c.getUniformLocation("lighting.ambient"),this.ambient.x,this.ambient.y,this.ambient.z,1)},UNIT_SQUARE_DATA=[{position:[-.5,.5,0,1],texCord:[0,0]},{position:[.5,.5,0,1],texCord:[1,0]},{position:[-.5,-.5,0,1],texCord:[0,1]},{position:[.5,-.5,0,1],texCord:[1,1]}],UNIT_SQUARE_ELEMS=[0,2,3,0,3,1],j.DEFAULT_NORMAL_MAP_=null,j.defaultNormalMap_=function(a){return j.DEFAULT_NORMAL_MAP_||(j.DEFAULT_NORMAL_MAP_=i.ofColor(a,"#8888ff")),j.DEFAULT_NORMAL_MAP_},j.prototype.setScale=function(a,b){this.ws_=a,this.hs_=b},j.prototype.size=function(){return new geom.Vec2(this.w_*this.ws_,this.h_*this.hs_)},j.prototype.scale=function(){return new geom.Vec2(this.ws_,this.hs_)},j.prototype.pos=function(){return this.pos_},j.prototype.addPos=function(a,b,c){this.pos_.x+=a||0,this.pos_.y+=b||0,this.pos_.z+=c||0},j.prototype.setPos=function(a,b,c){var d=isDef(c)?c:this.pos_.z;this.pos_.x=a,this.pos_.y=b,this.pos_.z=d},j.prototype.setRotation=function(a,b){this.axis_=a,this.angle_=b},j.prototype.axis=function(){return this.axis_},j.prototype.setTexture=function(a){this.texture=a,this.w_=a.w,this.h_=a.h},j.prototype.setNormalMap=function(a){this.normalMap=a},SHARED_SHADER={UNIFORMS:["uniform mat4 cameraToClipMatrix;","uniform mat4 modelToCameraMatrix;","uniform mat3 normalModelToCameraMatrix;","uniform vec3 lightPos;","uniform vec4 beats;"].join("\n"),TEXTURE_SAMPLERS:["uniform sampler2D diffuseSampler;","uniform sampler2D normalSampler;"].join("\n"),SPRITE_ATTR:["attribute vec3 position;","attribute vec2 texCord;","attribute vec2 norCord;","attribute vec3 colorFilter;"].join("\n"),SPRITE_VARY:["varying vec3 frag_position;","varying vec4 frag_color;","varying vec2 frag_texCord;","varying vec2 frag_norCord;","varying vec3 frag_colorFilter;"].join("\n"),LIGHT_UNIFORMS:["const int numLights = 4;","struct Light {","  vec4 cameraSpacePos;","  vec4 intensity;","};","struct Lighting {","  vec4 ambient;","  float attenuation;","  float maxIntensity;","  float gamma;","  vec4 lights[numLights * 2];","};","uniform Lighting lighting;"].join("\n"),CALC_LIGHT:["float Attenuate(in vec3 pos, in vec3 lightPos, out vec3 lightDir) {","  vec3 diff = lightPos - pos;","  float distSquared = dot(diff, diff);","  lightDir = diff * inversesqrt(distSquared);","  return (1.0 / (1.0 + lighting.attenuation * distSquared));","}","","vec4 CalcLight(in vec3 normal, in vec4 color, in Light light) {","  vec3 lightDir;","  vec4 intensity;","  if (light.cameraSpacePos.w == 0.0) {","    lightDir = vec3(light.cameraSpacePos);","    intensity = normalize(light.intensity);","  } else {","    float atten = light.cameraSpacePos.w * Attenuate(frag_position, light.cameraSpacePos.xyz, lightDir);","    intensity = atten * light.intensity;","  }","  float incidence = dot(normal, lightDir);","  incidence = incidence < 0.0001 ? 0.0 : incidence;","  return color * intensity * incidence;","}"].join("\n")},SHADERS={TEXTURED_SPRITE_VERT:["precision mediump float;","precision mediump int;",SHARED_SHADER.SPRITE_ATTR,"",SHARED_SHADER.UNIFORMS,"",SHARED_SHADER.LIGHT_UNIFORMS,"",SHARED_SHADER.TEXTURE_SAMPLERS,"",SHARED_SHADER.SPRITE_VARY,"","void main(void) {","  vec4 fragP = vec4(position, 1.0);","  gl_Position = cameraToClipMatrix * fragP;","  frag_position = fragP.xyz;","  frag_texCord = texCord;","  frag_norCord = norCord;","  frag_colorFilter = colorFilter;","}"].join("\n"),TEXTURED_SPRITE_FRAG:["precision mediump float;","precision mediump int;",SHARED_SHADER.SPRITE_VARY,"",SHARED_SHADER.UNIFORMS,"",SHARED_SHADER.LIGHT_UNIFORMS,SHARED_SHADER.CALC_LIGHT,"",SHARED_SHADER.TEXTURE_SAMPLERS,"","void main(void) {","  vec3 rawNormal = texture2D(normalSampler, frag_norCord).rgb;","  vec3 normal = normalize(2.0 * (rawNormal - vec3(0.5, 0.5, 0.5)));","  vec4 diffuse = vec4(frag_colorFilter, 0.0) + texture2D(diffuseSampler, frag_texCord);","  vec4 accum = diffuse * lighting.ambient;","  for (int lightIndex = 0; lightIndex < numLights; lightIndex++) {","    Light light;","    light.cameraSpacePos = lighting.lights[lightIndex * 2];","    light.intensity = lighting.lights[lightIndex * 2 + 1];","    accum += CalcLight(normal, diffuse, light);","  }","  accum = accum / lighting.maxIntensity;","  accum.w *= lighting.maxIntensity;","  vec4 gamma = vec4(1.0 / lighting.gamma);","  gamma.w = 1.0;","  gl_FragColor = pow(accum, gamma);","}"].join("\n")},k.prototype.load=function(a,b){if(!this.loaded_){this.loaded_=!0;var c=b||function(){},d=a.gl(),e=a.shaderFromText("TEXTURED_SPRITE_FRAG",SHADERS.TEXTURED_SPRITE_FRAG,d.FRAGMENT_SHADER),f=a.shaderFromText("TEXTURED_SPRITE_VERT",SHADERS.TEXTURED_SPRITE_VERT,d.VERTEX_SHADER);this.texturedProg=a.shaderProgram("TEXTURE",[f,e]),c()}};var o={};o.IMAGE_TYPES={".png":!0,".jpg":!0,".jpeg":!0,".gif":!0},o.ATLAS_TYPES={".json":!0},o.Loader=function(a,b){this.gl=a,this.assets=b,this.loading=!1,this.loaded=!1,this.numLoaded=0,this.data={}},o.Loader.prototype.loadTexture_=function(a,b){this.data[a]=i.load(this.gl,a,b)},o.Loader.prototype.loadAtlas_=function(a,b){json.load(a,function(a){h.load(this.gl,a,function(a){for(var c in a.textures)this.data[c]=a.textures[c];b()}.bind(this))}.bind(this))},o.Loader.prototype.load=function(a){if(!this.loading&&!this.loaded){for(var b=function(){this.numLoaded++,this.numLoaded==1+this.assets.length&&(this.loading=!1,this.loaded=!0,a(this.data))}.bind(this),c=0;c<this.assets.length;c++){var d=this.assets[c],e=d.substr(d.lastIndexOf("."));if(e in o.IMAGE_TYPES)this.loadTexture_(d,b);else{if(!(e in o.ATLAS_TYPES))throw'Unknown asset type: "'+e+'"!';this.loadAtlas_(d,b)}}window.setTimeout(b,50)}},a.Resources=o,a.Stage=d,a.Renderer3d=e,a.MatrixStack=b,a.Shader=f,a.ShaderProgram=g,a.Texture=i,a.Sprite=j,a.Light=m}(window),function(a){function b(a,b){var c=0,d=a;return void 0!=b&&(c=a,d=b),c+Math.random()*(d-c)}function c(a,b){var c=0,d=a;return void 0!=b&&(c=a,d=b),c=Math.ceil(c),d=Math.ceil(d),c+Math.floor(Math.random()*(d-c))}var d=function(a){{var b=a.width/(window.innerWidth-50),c=a.height/(window.innerHeight-50),d=Math.max(b,c);Math.min(b,c)}a.style.transformOrigin="0 0",a.style.transform="scale("+1/d+")",a.style.webkitTransformOrigin="0 0",a.style.webkitTransform="scale("+1/d+")",a.style.marginLeft=a.width/d/-2+"px",a.parentElement.parentElement.style.width=window.innerWidth-50+"px",a.parentElement.parentElement.style.height=window.innerHeight-50+"px"},e=function(){this.stage=new Stage(WIDTH,HEIGHT),this.t=0,this.line=0,this.lines=["What we have here, recruit, is a war.","Hell, we had a war. What we have now is you.","And a time machine.","If you die, you get one chance to go back.","One chance to kill your killer.","And if you die before that,","who the hell got sent back?"],this.sprites=[]};e.prototype.tick=function(a){this.t+=a,KB.keyPressed(Keys.ENTER)&&(this.line++,this.t=2*this.line),this.t>2*this.lines.length&&GameState.push(new f);for(var b=0;b<this.sprites.length;b++){var c=0;this.t>2*b&&this.t<2*b+2&&(c=Math.min(1,this.t-2*b)),this.sprites[b].setScale(c,c)}},e.prototype.enter=function(){this.stage.lighting().ambient=new geom.Vec3(1,1,1);for(var a=0;a<this.lines.length;a++){var b=new Sprite(RENDERER.gl()),c=this.lines[a];b.setTexture(Texture.fromCanvas(RENDERER.gl(),{width:1024,height:32},function(a){a.fillStyle="#fff",a.font="20px monospace",a.textAlign="center",a.fillText(c,512,16)
})),b.beat=-1,this.stage.addSprite(b),b.setScale(0,0),this.sprites.push(b)}};var f=function(){this.stage=new Stage(WIDTH,HEIGHT)};f.prototype.tick=function(){KB.keyPressed(Keys.ENTER)&&GameState.push(new h)},f.prototype.enter=function(){this.stage.lighting().ambient=new geom.Vec3(1,1,1);var a=new Sprite(RENDERER.gl());a.setTexture(Texture.fromCanvas(RENDERER.gl(),{width:256,height:32},function(a){a.fillStyle="#fff",a.font="28px monospace",a.textAlign="center",a.fillText("SAVE YOURSELF",128,16)})),a.beat=3,this.stage.addSprite(a),a=new Sprite(RENDERER.gl()),a.setTexture(Texture.fromCanvas(RENDERER.gl(),{width:256,height:32},function(a){a.fillStyle="#fff",a.font="20px monospace",a.textAlign="center",a.fillText("PRESS [ENTER]",128,16)})),a.setPos(0,-100),this.stage.addSprite(a)};var g=function(a){this.play=a;var b=this.play.game.players.filter(function(a){return a&&!a.dead}).length;this.gameOver=0!=this.play.game.killers.length||b>0,this.gameOver=0!=this.play.game.killers.length||!this.play.game.players[0].dead,this.stage=a.stage,this.t=0,this.delayTime=2};g.prototype.tick=function(a){this.t+=a;var b=this.t/this.delayTime;b=Math.abs(Math.sin(2*b*Math.PI)),this.stage.lighting().lights[1]=new Light(new geom.Vec3(20*b,200*b,100),new geom.Vec3(.5+100*b,.5+10*b,.5+10*b));for(var c=this.play.game.fx,d=0;d<c.length;d++)c[d]&&(c[d].dead?(c[d].sprite&&this.stage.removeSprite(c[d].sprite),c[d]=null):c[d].tick(a));this.t>=this.delayTime&&(GameState.pop(),this.gameOver?GameState.pop():this.play.resetFromDeath())},g.prototype.enter=function(){if(this.text=new Sprite(RENDERER.gl()),this.gameOver){this.text.setTexture(RESOURCES["txt_broken.png"]);var a=new Sprite(RENDERER.gl()),b="total time: "+this.play.score.toFixed(4);a.setTexture(Texture.fromCanvas(RENDERER.gl(),{width:256,height:32},function(a){a.fillStyle="#fff",a.font="20px monospace",a.textAlign="center",a.fillText(b,128,16)})),a.setPos(0,-128,20),this.stage.addSprite(a),a.beat=3}else this.text.setTexture(RESOURCES["txt_fractured.png"]);this.text.setPos(0,0,50),this.text.setScale(3,3),p(this.text),this.stage.addSprite(this.text)},g.prototype.exit=function(){this.text.stage.removeSprite(this.text)};var h=function(){this.stage=new Stage(WIDTH,HEIGHT),this.seed=+Date.now(),this.score=0,this.recordings=[],this.game=new i(this.seed,this.recordings,this.stage)};h.prototype.enter=function(){this.game.enter()},h.prototype.resetFromDeath=function(){this.stage.clear(),this.game=new i(this.seed,this.recordings,this.stage),this.game.enter()},h.prototype.tick=function(a){var b=this.game.players.some(function(a){return a&&a.dead});return b?(this.recordings.unshift(this.game.players[0].getRecording()),this.restoreText&&this.restoreText.stage.removeSprite(this.restoreText),this.restoreText=null,this.score+=this.game?this.game.survivedTime:0,GameState.push(new g(this)),void 0):(this.game.tick(a),void 0)};var i=function(a,b,c){this.survivedTime=0,this.stage=c,GAME=this,this.detRand=new MT(a),this.players=[new u];for(var d=0;d<b.length;d++)this.players.push(new u(b[d]));this.players[0].sprite.colorFilter=new geom.Vec3(1.2,1,1),this.killers=this.players.map(function(a){return a.wasKilledBy}).filter(isDef),this.enemies=[],this.bullets=[],this.fx=[]};i.prototype.spawn=function(a,b){this.id++;var c=-1!=this.killers.indexOf(this.id),d=function(a){c&&a.setKiller(),a.tick(0),a.sprite.setScale(.01,.01);var b={game:this,enemy:a,sprite:a.sprite,left:1,tick:function(a){this.left-=a;var b=Math.max(.01,Math.pow(this.left,2));this.sprite.setScale(1-b,1-b),this.left<=0&&(this.dead=!0,this.sprite.setScale(1,1),this.sprite.stage.removeSprite(this.sprite),this.sprite=null,this.game.addEnemy(this.enemy))}};this.addFx(b)}.bind(this);if("homing"==a)this.addEnemy(new t(b,new m(this.players),this.id));else if("spinner"==a){{new s(b,this.id)}d(new s(b,this.id))}else"puffer"==a&&d(new r(b,this.id))},i.prototype.enter=function(){for(var a=32*Math.ceil(WIDTH/2/32),b=32*Math.ceil(HEIGHT/2/32),c=-a;a>c;c+=32)for(var d=-b;b>d;d+=32){var e=new Sprite(RENDERER.gl());e.setTexture(RESOURCES["grid_diffuse.png"]),e.setNormalMap(RESOURCES["grid_normal.png"]),e.setPos(c,d,-50),e.setScale(2,2),e.beat=Math.random()<.5?1:2,this.stage.addSprite(e)}this.t=0,this.id=0;for(var f=0;f<this.players.length;f++)this.stage.addSprite(this.players[f].sprite);for(var f=0;f<this.enemies.length;f++)this.stage.addSprite(this.enemies[f].sprite);this.stage.lighting().lights[0]=new Light(new geom.Vec3(0,0,20),new geom.Vec3(2.8,2.8,2.8)),this.stage.lighting().lights[3]=Light.globalLight(new geom.Vec3(1,1,-1),new geom.Vec3(.8,.8,.8));for(var f=0;30>f;f++){var c=this.detRand.nextSign();c*=this.detRand.nextFloat(100,300);var d=this.detRand.nextSign();d*=this.detRand.nextFloat(100,200),this.spawn("homing",new geom.Vec3(c,d,0))}for(var f=30;40>f;f++){var c=this.detRand.nextSign();c*=this.detRand.nextFloat(100,300);var d=this.detRand.nextSign();d*=this.detRand.nextFloat(100,200),this.spawn("puffer",new geom.Vec3(c,d,0))}},i.prototype.removeBulletsFrom=function(a){for(var b=0;b<this.bullets.length;b++)if(this.bullets[b]&&this.bullets[b].source==a.id){var c=this.bullets[b];this.bullets[b]=null,c.dead=!0,c.sprite.colorFilter=new geom.Vec3(-.5,-.5,-.5);var d={sp:new geom.Vec3(c.sprite.pos()),ep:new geom.Vec3(a.sprite.pos()),left:.3,sprite:c.sprite,tick:function(a){this.left-=a;var b=Math.sqrt(this.left/.3);this.sprite.setPos(b*this.sp.x+(1-b)*this.ep.x,b*this.sp.y+(1-b)*this.ep.y,b*this.sp.z+(1-b)*this.ep.z),this.sprite.setScale(b,b),this.left<=0&&(this.dead=!0,this.sprite.stage.removeSprite(this.sprite))}};GAME.addFx(d)}},i.prototype.killerIsDead=function(a){for(var b=this.killers.length-1;b>=0;b--)this.killers[b]==a.id&&this.killers.splice(b,1);0==this.killers.length&&(this.restoreNextFrame=a)},i.prototype.mergePlayer=function(a){var b=this.players.indexOf(a);if(0==b)throw"Bad bad bad";this.players[b]=null,a.dead=!0;var c=new geom.Vec3(a.sprite.pos()),d=this.players[0],e={left:1,sprite:a.sprite,tick:function(b){this.left-=b;var e=Math.sqrt(this.left),f=d.sprite.pos();a.sprite.setPos(e*c.x+(1-e)*f.x,e*c.y+(1-e)*f.y,e*c.z+(1-e)*f.z),this.left<=0&&(this.dead=!0,this.sprite.stage.removeSprite(this.sprite))}};GAME.addFx(e)},i.prototype.tick=function(a){if(this.t+=a,this.survivedTime+=a,this.restoreNextFrame){this.restoreNextFrame=!1,this.restoreText=new Sprite(RENDERER.gl()),this.restoreText.setTexture(RESOURCES["txt_restored.png"]),this.restoreText.setScale(3,3);var b={left:2,sprite:this.restoreText,tick:function(a){return this.left-=a,this.sprite.stage?(this.sprite.visible=3!=Math.floor(8*this.left)%4,this.left<=0&&(this.dead=!0,this.sprite.stage.removeSprite(this.sprite)),void 0):(this.dead=!0,void 0)}};this.stage.addSprite(this.restoreText),this.addFx(b)}this.collidePlayersWithEnemies();for(var c=0;c<this.bullets.length;c++)if(this.bullets[c])if(this.bullets[c].dead)this.stage.removeSprite(this.bullets[c].sprite),this.bullets[c]=null;else if(this.bullets[c].tick(a),this.bullets[c].friendly)for(var d=this.collideBullet(this.bullets[c],this.enemies),e=0;e<d.length;e++)d[e].hit(1);else for(var d=this.collideBullet(this.bullets[c],this.players),e=0;e<d.length;e++)d[e].kill(this.bullets[c].source);this.stage.lighting().lights[0].pos.x=this.players[0].sprite.pos().x,this.stage.lighting().lights[0].pos.y=this.players[0].sprite.pos().y;for(var c=0;c<this.players.length;c++)this.players[c]&&!this.players[c].dead&&this.players[c].tick(a);for(var c=0;c<this.enemies.length;c++){var f=this.enemies[c];f&&(f.dead||f.tick(a))}for(var c=0;c<this.fx.length;c++)this.fx[c]&&(this.fx[c].dead?(this.fx[c].sprite&&this.stage.removeSprite(this.fx[c].sprite),this.fx[c]=null):this.fx[c].tick(a));var g=0;if(Math.floor(this.t)!=Math.floor(this.t-a)&&(g=Math.floor(this.t)),10==g||g>10&&g%5==0)for(var c=0;20>c;c++){var h=this.detRand.nextFloat(2*Math.PI);this.spawn("homing",new geom.Vec2(WIDTH*Math.cos(h),HEIGHT*Math.sin(h)))}if(g>=8&&g%4==0)for(var c=0;2>c;c++){var i=this.detRand.nextInt(-350,350),j=this.detRand.nextInt(-250,250);this.spawn("spinner",new geom.Vec2(i,j))}if(g>=12&&g%6==0)for(var c=0;5>c;c++){var i=this.detRand.nextInt(-350,350),j=this.detRand.nextInt(-250,250);this.spawn("puffer",new geom.Vec2(i,j))}},i.prototype.collidePlayersWithEnemies=function(){for(var a=new geom.AABB,b=new geom.AABB,c=[],d=[],e=0;e<this.players.length;e++){var f=this.players[e];if(f&&!f.dead){a.m_fromCenterAndSize(f.sprite.pos(),f.sprite.size());for(var g=0;g<this.enemies.length;g++){var h=this.enemies[g];if(h&&!h.dead&&(b.m_fromCenterAndSize(h.sprite.pos(),h.sprite.size()),a.overlaps(b))){c.push([f,h.id]);var i=d.indexOf(h);-1==i&&d.push(h)}}}}for(var e=0;e<d.length;e++)d[e].hit(1/0);for(var e=0;e<c.length;e++)c[e][0].kill(c[e][1])},i.prototype.collideBullet=function(a,b){for(var c=[],d=geom.AABB.fromCenterAndSize(a.sprite.pos(),a.sprite.size()),e=new geom.AABB(0,0,0,0),f=0;f<b.length;f++){var g=b[f];g&&!g.dead&&(e.m_fromCenterAndSize(g.sprite.pos(),g.sprite.size()),e.overlaps(d)&&(a.dead=!0,c.push(g)))}return c},i.prototype.addEnemy=function(a){-1!=this.killers.indexOf(a.id)&&a.setKiller(),this.stage.addSprite(a.sprite);for(var b=0;b<this.enemies.length;b++)if(!this.enemies[b])return this.enemies[b]=a,void 0;this.enemies.push(a)},i.prototype.addBullet=function(a){this.stage.addSprite(a.sprite);for(var b=0;b<this.bullets.length;b++)if(!this.bullets[b])return this.bullets[b]=a,void 0;this.bullets.push(a)},i.prototype.addFx=function(a){this.stage.addSprite(a.sprite);for(var b=0;b<this.fx.length;b++)if(!this.fx[b])return this.fx[b]=a,void 0;this.fx.push(a)};var j=function(a){this.c=a,this.t=0,this.es=[{t:0,d:0}]};j.prototype.get=function(){return this.es.concat({t:this.t,d:32})},j.prototype.tick=function(a){this.c.tick(a);var b=0;this.c.left()&&(b|=1),this.c.right()&&(b|=2),this.c.up()&&(b|=4),this.c.down()&&(b|=8),this.c.shoot()&&(b|=16),b!=this.es[this.es.length-1].d&&this.es.push({t:this.t,d:b}),this.t+=a},j.prototype.left=function(){return this.c.left()},j.prototype.right=function(){return this.c.right()},j.prototype.up=function(){return this.c.up()},j.prototype.down=function(){return this.c.down()},j.prototype.shoot=function(){return this.c.shoot()},j.prototype.merge=function(){return this.c.merge()};var k=function(a){this.es=a,this.ei=-1,this.t=0,this.dleft=this.dright=this.dup=this.ddown=this.dshoot=!1};k.prototype.tick=function(a){if(this.t+=a,this.ei+1<this.es.length&&this.es[this.ei+1].t<this.t){this.ei++;var b=this.es[this.ei]&&this.es[this.ei].d||0;this.dleft=1&b,this.dright=2&b,this.dup=4&b,this.ddown=8&b,this.dshoot=16&b,this.dmerge=this.ei==this.es.length-1}},k.prototype.left=function(){return this.dleft},k.prototype.right=function(){return this.dright},k.prototype.up=function(){return this.dup},k.prototype.down=function(){return this.ddown},k.prototype.shoot=function(){return this.dshoot},k.prototype.merge=function(){return this.dmerge};var l=function(){this.shotTimer=0};l.prototype.tick=function(a){this.shotTimer-=a,this.didShoot&&(this.didShoot=!1,this.shotTimer=.13)},l.prototype.left=function(){return KB.keyDown(Keys.LEFT)},l.prototype.right=function(){return KB.keyDown(Keys.RIGHT)},l.prototype.up=function(){return KB.keyDown(Keys.UP)},l.prototype.down=function(){return KB.keyDown(Keys.DOWN)},l.prototype.shoot=function(){return this.didShoot||this.shotTimer<=0?(this.didShoot=!0,!0):!1},l.prototype.merge=function(){return!1};var m=function(a){this.targets=a,this.ti=this.targets.length-1};m.prototype.tick=function(a){for(;this.ti>=0&&(!this.target||this.target.dead);)this.target=this.targets[this.ti],this.ti--;var b=this.me.sprite.pos().toVec2(),c=this.target.sprite.pos().toVec2(),d=c.minus(b).theta(),e=this.me.vel.theta(),f=d-e;f>Math.PI||0>f&&f>-Math.PI?e-=a:e+=a,this.me.vel.x=100*Math.cos(e),this.me.vel.y=100*Math.sin(e),this.me.sprite.setRotation(this.me.sprite.axis(),e)};var n=function(a,b){this.scale=b.scale||1,this.vel=b.vel,this.friendly=!!b.friendly,this.source=b.source,this.sprite=new Sprite(RENDERER.gl()),this.sprite.setTexture(RESOURCES[a+"_diffuse.png"]),this.sprite.setNormalMap(RESOURCES[a+"_normal.png"]),this.sprite.setPos(b.pos.x,b.pos.y,b.pos.z||-1),this.sprite.setRotation(new geom.Vec3(0,0,1),this.vel.toVec2().theta()),1!=this.scale&&this.sprite.setScale(this.scale,this.scale)};n.prototype.tick=function(a){var b=this.sprite.pos();return b.x<-WIDTH/2||b.x>WIDTH/2||b.y<-HEIGHT/2||b.y>HEIGHT/2?(this.dead=!0,void 0):(this.sprite.addPos(this.vel.x*a,this.vel.y*a),void 0)};var o=function(a,c){if(this.sprite=new Sprite(RENDERER.gl()),a.diffuse){var d=a;this.sprite.setTexture(d.diffuse),this.sprite.setNormalMap(d.normal)}else{var e=a;this.sprite.setTexture(RESOURCES[e+"_diffuse.png"]),this.sprite.setNormalMap(RESOURCES[e+"_normal.png"])}this.sprite.setPos(c.pos.x,c.pos.y,c.pos.z||-1),this.vel=c.vel,this.rotAxis=new geom.Vec3(this.vel.y,-this.vel.x,b(-.5,.5)).normalize(),this.rotAngle=0,this.scale=this.sprite.scale(),isDef(c.scale)&&(this.scale=c.scale.x?c.scale:new geom.Vec2(c.scale,c.scale),this.sprite.setScale(this.scale.x,this.scale.y)),this.life=this.duration=c.duration||2,this.shrink=isDef(c.shrink)?c.shrink:!0};o.prototype.tick=function(a){if(this.life-=a,this.life<0)return this.dead=!0,void 0;this.rotAngle+=a*this.vel.mag()/10,this.sprite.addPos(this.vel.x*a,this.vel.y*a),this.sprite.setRotation(this.rotAxis,this.rotAngle);var b=this.life/this.duration;this.shrink&&this.sprite.setScale(this.scale.x*b,this.scale.y*b)};var p=function(a){if(a.axis())throw"Cannae break rotated sprites";for(var c=a.pos(),d=a.size(),e=a.scale(),f=d.x/2/e.x,g=d.y/2/e.y,h=-g;g>h;h+=8)for(var i=-f;f>i;i+=8){var j={diffuse:Texture.sub(a.texture,new geom.Vec2(f+i,g+h),new geom.Vec2(8,8)),normal:Texture.sub(a.normalMap,new geom.Vec2(f+i,g+h),new geom.Vec2(8,8))};GAME.addFx(new o(j,{life:b(1.5,2),pos:new geom.Vec3(c.x+i*e.x,c.y-h*e.y,c.z),vel:new geom.Vec3(i,-h,0).normalize().times(b(15,27)),scale:a.scale(),shrink:!1}))}},q=function(a,c){for(var d=0;c>d;d++){{var e=b(2*-c,2*c),f=b(2*-c,2*c);Math.sqrt(e*e+f*f)}GAME.addFx(new o("smoke",{life:b(1.5,2),pos:new geom.Vec3(a.x+e/c,a.y+f/c,-1),vel:new geom.Vec3(5*e,5*f,0),scale:Math.max(1,Math.log(c)/Math.log(10))}))}},r=function(a,b){this.id=b,this.life=5,this.dir=GAME.detRand.nextFloat(2*Math.PI),this.nextPuff=1,this.sprite=new Sprite(RENDERER.gl()),this.sprite.setTexture(RESOURCES["puffer_diffuse.png"]),this.sprite.setNormalMap(RESOURCES["puffer_normal.png"]),this.sprite.setPos(a.x,a.y,a.z),this.sprite.beat=b%4};r.prototype.setKiller=function(){this.killer=!0,this.sprite.colorFilter=new geom.Vec3(-.2,1.2,1)},r.prototype.hit=function(a){q(this.sprite.pos(),2),this.life-=a,this.life<=0&&this.kill()},r.prototype.kill=function(){this.dead||(this.dead=!0,q(this.sprite.pos(),c(15,25)),this.sprite.stage.removeSprite(this.sprite),this.killer&&GAME.killerIsDead(this),GAME.removeBulletsFrom(this))},r.prototype.tick=function(a){this.nextPuff-=a,this.nextPuff<0&&(this.nextPuff+=2);var b=1;this.nextPuff>1.7?b=4-3*Math.sqrt((2-this.nextPuff)/.3):this.nextPuff<1&&(b=1+3*Math.pow(1-this.nextPuff,3)),this.sprite.setScale(b,b),0!=a&&(this.sprite.addPos(100*Math.cos(this.dir)*a,100*Math.sin(this.dir)*a),this.dir+=a,this.dir%=2*Math.PI)};var s=function(a,b){this.id=b,this.life=5,this.shotDelay=1.3,this.theta=996610*b%(2*Math.PI),this.sprite=new Sprite(RENDERER.gl()),this.sprite.setTexture(RESOURCES["spinner_diffuse.png"]),this.sprite.setPos(a.x,a.y,a.z),this.sprite.beat=b%4};s.prototype.setKiller=function(){this.killer=!0,this.sprite.colorFilter=new geom.Vec3(.2,1.2,1)},s.prototype.hit=function(a){q(this.sprite.pos(),2),this.life-=a,this.life<=0&&this.kill()},s.prototype.kill=function(){this.dead||(this.dead=!0,q(this.sprite.pos(),c(15,25)),this.sprite.stage.removeSprite(this.sprite),this.killer&&GAME.killerIsDead(this),GAME.removeBulletsFrom(this))},s.prototype.tick=function(a){if(this.theta+=a,this.theta%=2*Math.PI,this.sprite.setRotation(new geom.Vec3(Math.cos(this.theta),Math.sin(this.theta),10).normalize(),this.theta),this.shotDelay-=a,this.shotDelay<0){this.shotDelay+=1.3;for(var b=this.sprite.size(),c=0;3>c;c++){var d=new geom.Vec3(b.x*Math.cos(this.theta+2*c*Math.PI/3),b.y*Math.sin(this.theta+2*c*Math.PI/3),0);GAME.addBullet(new n("rbullet",{scale:2,pos:d.plus(this.sprite.pos()),vel:d.normalize().times(80),friendly:!1,source:this.id}))}}};var t=function(a,b,c){this.id=c,this.vel=new geom.Vec2(0,0),this.inertia=.2,this.controller=b,this.controller.me=this,this.sprite=new Sprite(RENDERER.gl()),this.sprite.setTexture(RESOURCES["enemy_diffuse.png"]),this.sprite.setNormalMap(RESOURCES["enemy_normal.png"]),this.sprite.setPos(a.x,a.y,a.z),this.sprite.setRotation(new geom.Vec3(0,0,1)),this.sprite.beat=c%4};t.prototype.setKiller=function(){this.killer=!0,this.sprite.colorFilter=new geom.Vec3(-.2,8.2,8)},t.prototype.hit=function(){this.kill()},t.prototype.kill=function(){this.dead||(this.dead=!0,q(this.sprite.pos(),c(4,10)),this.sprite.stage.removeSprite(this.sprite),this.killer&&GAME.killerIsDead(this))},t.prototype.tick=function(a){this.controller.tick(a);new geom.Vec2(0,0);this.sprite.addPos(this.vel.x*a,this.vel.y*a)};var u=function(a){a?(this.controller=new k(a.moves),this.wasKilledBy=a.killedBy):(this.primary=!0,this.controller=new l),this.controller=new j(this.controller),this.sprite=new Sprite(RENDERER.gl()),this.sprite.setTexture(RESOURCES["player_diffuse.png"]),this.sprite.setNormalMap(RESOURCES["player_normal.png"]),this.sprite.setRotation(new geom.Vec3(0,0,1),0),this.shotDir=new geom.Vec2(1,0),this.targetShotDir=new geom.Vec2(1,0)};u.prototype.getRecording=function(){return{moves:this.controller.get(),killedBy:this.killedBy}},u.prototype.kill=function(a){if(!this.dead){if(isDef(this.wasKilledBy)&&this.wasKilledBy!=a){var b=new Sprite(RENDERER.gl());return b.setTexture(RESOURCES["txt_desync.png"]),p(b),void 0}this.dead=!0,this.killedBy=a,q(this.sprite.pos(),20),this.sprite.stage.removeSprite(this.sprite)}},u.prototype.tick=function(a){this.controller.tick(a);var b=!1,c=!1;this.controller.left()&&(b=!0,this.targetShotDir.x=-1,this.sprite.addPos(-100*a,0)),this.controller.right()&&(b=!0,this.targetShotDir.x=1,this.sprite.addPos(100*a,0)),this.controller.up()&&(c=!0,this.targetShotDir.y=1,this.sprite.addPos(0,100*a)),this.controller.down()&&(c=!0,this.targetShotDir.y=-1,this.sprite.addPos(0,-100*a)),b!=c&&(b||(this.targetShotDir.x=0),c||(this.targetShotDir.y=0));var d=this.targetShotDir.theta(),e=this.shotDir.theta(),f=d-e;f>Math.PI||0>f&&f>-Math.PI?e-=Math.min(Math.abs(f),7*a):e+=Math.min(Math.abs(f),7*a),this.shotDir.x=Math.cos(e),this.shotDir.y=Math.sin(e),this.sprite.setRotation(this.sprite.axis(),e),this.controller.shoot()&&GAME.addBullet(new n("bullet",{pos:new geom.Vec3(this.sprite.pos()),vel:this.shotDir.toVec3().times(290),friendly:!0,scale:1.5,source:this.id})),this.controller.merge()&&GAME.mergePlayer(this)},WIDTH=800,HEIGHT=600;var v=function(){var a=document.getElementById("game"),b=new Renderer3d(a,WIDTH,HEIGHT);RENDERER=b;var c=b.getElement();d(c),window.addEventListener("resize",d.bind(null,c));var f=b.gl(),g=!0,h=!0,i=new Resources.Loader(f,["sprite.json"]),j={elem:a,tick:function(b){(g||KB.keyPressed("]"))&&GameState.tick(b),KB.keyPressed("P")&&(g=!g),KB.keyPressed("O")&&(h=!h),KB.keyPressed(Keys.ESCAPE)&&a.blur()},render:function(){h&&GameState.render(b)}};i.load(function(a){RESOURCES=a,GameState.push(new e),Pidgine.run(j)})};a.init=v}(window);